# 并发思路

**访问量大的数据统计接口**

* **需求：** 用户行为数据统计接口，用来记录商品展示次数，用户通过点击图片，或者链接，或者其他方式进入到商品详情的行为次数。
* **问题点：**这接口是给前端ajax使用，访问量会很大，一页面展示的时候就会有几十件商品的展示，滚动条滚到到页面显示商品的时候就会请求接口进行展示数据的统计，每次翻页又会加载几十件。
* **意淫分析：**设想如果同时有1W个用户同时在线访问页面，一个次拉动滚动条屏幕页面展示10件商品，这样就会有10W个请求过来，服务端需要把请求数据入库。在实际线上环境可能还会超过这个请求量，如果不经过进行高并发设计处理，服务器分分钟给跪了。
* **解决问题：**我们通过nodejs写了一个数据处理接口，把统计数据先存到redis的list里。\(使用nodejs写接口的好处是，nodejs使用单线程异步事件机制，高并发处理能力强，不会因为数据逻辑处理问题导致服务器资源被占用而导致服务器宕机\) 然后再使用nodejs写了一个脚本，脚本功能就是从redis里出列数据保存到mysql数据库中。这个脚本会一直运行，当redis没有数据需要同步到数据库中的时候，sleep，让在进行数据同步操作。



####  **高并发的下的服务器压力均衡，合理站点架设，DB部署**

1. 服务器代理nginx，做服务器的均衡负载，把压力均衡到多台服务器；
2. 部署集群MySQL数据库， Redis服务器，或者MongoDB服务器，把一些常用的查询数据，并且不会经常的变化的数据保存到其他NoSQL DB服务器中，来减少数据库服务器的压力，加快数据的响应速度；
3. 数据缓存，Cache；
4. 在高并发接口的设计中可以使用具有高并发能力的编程语言去开发，如：nodejs做web接口；
5. 服务器部署，图片服务器分离，静态文件走CDN；
6. DBA数据库的优化查询条件，索引优化；
7. 消息存储机制，将数据添加到信息队列中\(redis list\)，然后再写工具去入库
8. 脚本合理控制请求，如，防止用户重复点击导致的ajax多余的请求，等等



[https://wetest.qq.com/lab/view/177.html](https://wetest.qq.com/lab/view/177.html)

